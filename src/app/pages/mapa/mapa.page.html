<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button class="back-chevron" text="" color="primary" defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Mapa</ion-title>
    <ion-badge slot="end" color="primary" class="ion-margin-end">Rol: {{ userRole() || '...' }}</ion-badge>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true">
  <ion-list inset="true">
    <ion-item>
      <ion-label>Calles</ion-label>
      <ion-toggle slot="end" [checked]="showCalles()" (ionChange)="onToggleCalles($event)"></ion-toggle>
    </ion-item>
    <ion-item>
      <ion-label>Rutas</ion-label>
      <ion-toggle slot="end" [checked]="showRutas()" (ionChange)="onToggleRutas($event)"></ion-toggle>
    </ion-item>
    @if (userRole() !== 'cliente') {
      <ion-item class="route-row" button detail (click)="openRoutePicker()">
        <ion-label>Ruta</ion-label>
        <ion-note slot="end">{{ selectedRutaNombre || 'Selecciona' }}</ion-note>
      </ion-item>
      @if (supportsRecorridos) {
        @if (userRole() === 'conductor') {
          <ion-item class="actions-inline">
            <ion-label>Ubicación real</ion-label>
            <ion-toggle slot="end" [checked]="realTracking()" (ionChange)="onToggleRealTracking($event)"></ion-toggle>
          </ion-item>
          <ion-item lines="none" class="actions-inline">
            <ion-button size="small" color="success" [disabled]="!selectedRutaId()" (click)="onStartRecorrido()">Iniciar</ion-button>
            <ion-button size="small" color="warning" [disabled]="!activeRecorrido()" (click)="onFinishRecorrido()" class="ion-margin-start">Finalizar</ion-button>
            @if (activeRecorrido()) {
              <ion-badge color="tertiary" class="ion-margin-start">En progreso</ion-badge>
            }
          </ion-item>
        }
      }
    }
   
  </ion-list>
  @if (userRole() === 'admin') {
    <ion-list inset="true">
      <ion-item lines="none" class="actions-inline">
        <ion-button size="small" color="primary" (click)="toggleEditing()">{{ editing() ? 'Salir edición' : 'Editar ruta' }}</ion-button>
        <ion-button size="small" color="medium" (click)="undoLast()" [disabled]="draftCount() === 0">Deshacer</ion-button>
        <ion-button size="small" color="light" (click)="clearDraft()" [disabled]="draftCount() === 0">Limpiar</ion-button>
      </ion-item>
      <ion-item lines="none" class="actions-inline">
        <ion-button size="small" color="secondary" (click)="startEditSelectedRuta()" [disabled]="!selectedRutaId()">Editar geom. ruta</ion-button>
        <ion-button size="small" color="success" (click)="saveEditedRuta()" [disabled]="!editingSelected() || draftCount() < 2">Guardar cambios</ion-button>
        <ion-button size="small" color="medium" (click)="cancelEditRuta()" [disabled]="!editingSelected()">Cancelar</ion-button>
      </ion-item>
      <ion-item lines="none" class="actions-inline">
        <ion-button size="small" color="success" (click)="saveDraftAsRuta()" [disabled]="draftCount() < 2">Guardar Ruta ({{ draftCount() }})</ion-button>
        <ion-button size="small" color="tertiary" (click)="saveDraftAsCalle()" [disabled]="draftCount() < 2">Guardar Calle</ion-button>
      </ion-item>
    </ion-list>
  }
  <ion-card id="mapa-map"></ion-card>

  @if (userRole() !== 'cliente') {
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label>Rutas</ion-label>
        <ion-note slot="end">{{ rutas().length || 0 }} disponibles</ion-note>
      </ion-item>
      @for (r of rutas(); track r.id) {
        <ion-item button (click)="selectRuta(r.id)">
          <ion-label>{{ r.nombre || r.nombre_ruta }}</ion-label>
          @if (selectedRutaId() === r.id) { <ion-badge color="primary" slot="end">Seleccionada</ion-badge> }
        </ion-item>
      }
    </ion-list>
    @if (userRole() === 'conductor' || userRole() === 'admin') {
      <ion-list inset="true">
        <ion-item lines="full">
          <ion-label>Vehículos Disponibles</ion-label>
          <ion-note slot="end">{{ availableVehicles().length || 0 }} de {{ vehicles().length }}</ion-note>
        </ion-item>
        @for (v of availableVehicles(); track v.id) {
          <ion-item button (click)="selectVehiculo(v.id)">
            <ion-label>{{ v.placa }}@if (v.modelo) { <span> · {{ v.modelo }}</span> }</ion-label>
            @if (selectedVehiculoId() === v.id) { <ion-badge color="primary" slot="end">Seleccionado</ion-badge> }
          </ion-item>
        }
      </ion-list>
    }
  }
</ion-content>